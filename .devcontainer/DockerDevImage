# .devcontainer/Dockerfile
# Base runtime image: CUDA + cuDNN + Ubuntu 22.04
FROM nvidia/cuda:12.6.3-cudnn-runtime-ubuntu22.04

ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    PATH=/root/.local/bin:$PATH

ENV LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/local/lib/python3.12/dist-packages/nvidia/cudnn/lib

# Install Python 3.12 and basic tooling
RUN apt-get update && \
    apt-get install -y --no-install-recommends software-properties-common && \
    add-apt-repository ppa:deadsnakes/ppa -y && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        sudo \
        wget \
        ffmpeg \
        apt-transport-https \
        curl \
        ca-certificates \
        python3.12 \
        python3.12-dev \
        python3.12-venv \
    && curl -sS https://bootstrap.pypa.io/get-pip.py | python3.12 \
    && rm -rf /var/lib/apt/lists/*

# Make Python 3.12 the default python3 non-interactively
RUN update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.12 2 && \
    update-alternatives --set python3 /usr/bin/python3.12 && \
    ln -sf /usr/bin/python3.12 /usr/bin/python || true

WORKDIR /workspace

# requirements.txt is in the repo root, which is our build context ("..")
COPY requirements.txt /workspace/requirements.txt

# Install Python packages baked into the image
RUN python3 -m pip install --upgrade pip && \
    python3 -m pip install -r /workspace/requirements.txt && \
    rm -rf /root/.cache/pip

CMD ["bash"]
