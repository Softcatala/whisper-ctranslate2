name: CI

on:
  push:
    branches: ['**']
    tags: ['**']
  pull_request:
    branches: [main]
  schedule:
    - cron: "0 0 * * 0"

jobs:
  # check-code-format:
  #   runs-on: ubuntu-22.04
  #   steps:
  #     - uses: actions/checkout@v4

  #     - uses: actions/setup-python@v5
  #       with:
  #         python-version: "3.12"
  #         cache: "pip"
  #         cache-dependency-path: |
  #           pyproject.toml
  #           setup.cfg

  #     - name: Install dev tools
  #       run: pip install -e .[dev]

  #     - name: Check code format with Black
  #       run: black --check src/ tests/ e2e-tests/

  #     - name: Check code style with Flake8
  #       if: ${{ always() }}
  #       run: flake8 src/ tests/ e2e-tests/

  #     - name: Check code style with isort
  #       if: ${{ always() }}
  #       run: isort --check-only src/ tests/ e2e-tests/

  run-tests:
    environment: CI/CD
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04]
        python-version: ["3.10", "3.11", "3.12", "3.13"]  # Drop 3.14 for now
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Free disk space
        shell: bash
        run: |
          set -eux
          df -h
          # Biggest low-risk win on hosted runners:
          sudo rm -rf /opt/hostedtoolcache
          # Optional extra cleanup:
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/.ghcup
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          df -h

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"
          cache-dependency-path: |
            pyproject.toml
            setup.cfg

      - name: Install Ubuntu dependency
        run: |
          sudo apt-get update
          sudo apt-get install -y libportaudio2 ffmpeg

      - name: Install module
        run: |
          pip install wheel
          pip install -e .[dev]

      - name: Configure GPU libs or force CPU
        shell: bash
        run: |
          set -euo pipefail

          # Detect whether a CUDA driver/GPU is actually present
              if command -v nvidia-smi >/dev/null 2>&1; then
                echo "GPU runner detected (nvidia-smi present). Looking for cuDNN..."

                CUDNN_LIB=$(
                  python -c "import importlib.util, pathlib, sys
          mods=('nvidia.cudnn','nvidia.cudnn_jit')
          for mod in mods:
              spec=importlib.util.find_spec(mod)
              if spec and spec.origin:
                  p=pathlib.Path(spec.origin).resolve().parent/'lib'
                  if p.exists():
                      print(p); sys.exit(0)
          sys.exit(1)
          " 2>/dev/null || true
                )

            # 2) Fallback: linker cache
            if [ -z "$CUDNN_LIB" ]; then
              CUDNN_LIB=$(ldconfig -p | awk '/libcudnn.*so/{print $NF; exit}' | xargs -r dirname || true)
            fi

            # 3) Fallback: brute find in common roots
            if [ -z "$CUDNN_LIB" ]; then
              CUDNN_LIB=$(sudo find /usr /opt /home/runner -type f -name 'libcudnn*.so*' 2>/dev/null \
                | head -n1 | xargs -r dirname || true)
            fi

            if [ -z "$CUDNN_LIB" ]; then
              echo "cuDNN not found even though GPU runner detected."
              exit 1
            fi

            echo "Found cuDNN at: $CUDNN_LIB"
            echo "LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$CUDNN_LIB" >> "$GITHUB_ENV"

          else
            echo "No GPU/driver detected. Forcing CPU mode."
            echo "CUDA_VISIBLE_DEVICES=" >> "$GITHUB_ENV"
          fi
      # TODO: Fix tests and enable them again
      # - name: Run tests
      #   run: make run-tests

      - name: Run e2e tests
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          make install-dependencies-e2e-tests
          make run-e2e-tests
